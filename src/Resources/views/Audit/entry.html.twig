{% import '@DHAuditor/Audit/helpers/helper.html.twig' as helper %}

<details class="group">
    <summary class="flex flex-col px-4 py-3 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800/50 transition list-none">
        {# First line: badge, entity link, hash, chevron #}
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3 min-w-0">
                {# Type badge - fixed width for alignment #}
                <span class="w-24 shrink-0">
                    {{ helper.type_badge(entry.type) }}
                </span>

                {# Entity label with link and FQCN title #}
                <a href="{{ path('dh_auditor_show_entity_stream', {'entity': helper.namespaceToParam(entity), 'id': entry.objectId}) }}"
                   class="font-medium text-slate-900 dark:text-slate-100 hover:underline truncate"
                   title="{{ entity }}"
                   onclick="event.stopPropagation();">
                    {{ entity|split('\\')|last }} #{{ entry.objectId }}
                </a>
            </div>

            <div class="flex items-center gap-4 text-sm text-slate-500 dark:text-slate-400 shrink-0">
                {# Transaction hash - short version with full hash in title #}
                {% if entry.transactionHash is not empty and hide_transaction is not defined %}
                    <a href="{{ path('dh_auditor_show_transaction_stream', {hash: entry.transactionHash}) }}"
                       class="font-mono text-xs text-slate-400 hover:underline transition"
                       title="{{ entry.transactionHash }}"
                       onclick="event.stopPropagation();">
                        {{ entry.transactionHash|slice(0, 10) }}…
                    </a>
                {% endif %}

                {# Chevron #}
                <svg class="w-4 h-4 text-slate-400 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>

        {# Second line: date and user/command #}
        <div class="flex items-center gap-2 mt-1 ml-2 text-xs text-slate-500 dark:text-slate-400">
            <span>{{ entry.createdAt|format_datetime('full', 'short') }}</span>
            <span>·</span>
            <span>{% trans from 'auditor' %}audit.entry.by{% endtrans %}
                <span class="font-medium">{{ entry.username ?? 'audit.audit_details.anonymous'|trans(domain='auditor') }}</span>
            </span>
        </div>
    </summary>

    {# Details content - diffs #}
    {% if entry.type in ['insert', 'update'] %}
        <div class="px-4 pb-4">
            <div class="pl-4 text-sm">
                {% set diffs = entry.diffs %}
                {% for field, changeset in diffs %}
                    {{ _self.displayDiff(field, changeset) }}
                {% endfor %}
            </div>
        </div>
    {% elseif entry.type in ['associate', 'dissociate'] %}
        <div class="px-4 pb-4">
            <div class="pl-4 text-sm">
                {% set diffs = entry.diffs %}
                {% if diffs.source is defined %}
                    <div class="flex items-center gap-2 text-slate-600 dark:text-slate-300">
                        <span class="text-slate-400">{% trans from 'auditor' %}audit.entry.source{% endtrans %}:</span>
                        <span class="font-medium">{{ diffs.source.label|default(diffs.source.class ~ '#' ~ diffs.source.id) }}</span>
                    </div>
                {% endif %}
                {% if diffs.target is defined %}
                    {% set target_id = diffs.target.pkName is defined ? diffs.target[diffs.target.pkName] : diffs.target.id %}
                    <div class="flex items-center gap-2 text-slate-600 dark:text-slate-300 mt-1">
                        <span class="text-slate-400">{% trans from 'auditor' %}audit.entry.target{% endtrans %}:</span>
                        <a href="{{ path('dh_auditor_show_entity_stream', { 'entity': helper.namespaceToParam(diffs.target.class), 'id': target_id }) }}"
                           class="font-medium text-blue-600 dark:text-blue-400 hover:underline">
                            {{ diffs.target.label|default(diffs.target.class|split('\\')|last ~ '#' ~ target_id) }}
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    {% elseif entry.type == 'remove' %}
        <div class="px-4 pb-4">
            <div class="pl-4 text-sm">
                {% set diffs = entry.diffs %}
                {% for field, value in diffs %}
                    <div class="flex gap-2 py-1">
                        <span class="text-slate-500 dark:text-slate-400 min-w-32">{{ field }}</span>
                        <span class="text-rose-500 dark:text-rose-400">{{ helper.dump(value) }}</span>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}
</details>

{% macro displayDiff(field, changeset) %}
    {% import '@DHAuditor/Audit/helpers/helper.html.twig' as helper %}
    {% if changeset.old is defined or changeset.new is defined %}
        <div class="flex gap-2 py-1 items-start">
            <span class="text-slate-500 dark:text-slate-400 min-w-32 shrink-0">{{ field }}</span>
            <span class="text-slate-400 dark:text-slate-500">
                {% if changeset.old is defined and changeset.old is not null %}
                    <span class="text-rose-400 dark:text-rose-500 line-through">{{ helper.dump(changeset.old) }}</span>
                {% else %}
                    <span class="text-slate-300 dark:text-slate-600">⌀</span>
                {% endif %}
            </span>
            <span class="text-slate-400 dark:text-slate-500">→</span>
            <span>
                {% if changeset.new is defined and changeset.new is not null %}
                    <span class="text-blue-600 dark:text-blue-400">{{ helper.dump(changeset.new) }}</span>
                {% else %}
                    <span class="text-slate-300 dark:text-slate-600">⌀</span>
                {% endif %}
            </span>
        </div>
    {% else %}
        {# JSON nested field #}
        {% for json_field, json_changeset in changeset %}
            {{ _self.displayDiff(field ~ '.' ~ json_field, json_changeset) }}
        {% endfor %}
    {% endif %}
{% endmacro %}
