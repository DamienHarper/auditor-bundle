{% import '@DHAuditor/Audit/helpers/helper.html.twig' as helper %}

{# Get entity label from diffs if available #}
{% set entity_label = null %}
{% if entry.diffs.label is defined %}
    {% set entity_label = entry.diffs.label %}
{% endif %}

<details class="group">
    <summary class="flex flex-col px-4 py-3 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800/50 transition list-none">
        {# First line: badge, entity link, label, action description, hash, chevron #}
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3 min-w-0">
                {# Type badge - fixed width for alignment #}
                <span class="w-24 shrink-0">
                    {{ helper.type_badge(entry.type) }}
                </span>

                {# Entity info #}
                <div class="flex items-center gap-2 min-w-0 text-sm">
                    {# Entity name + ID #}
                    <a href="{{ path('dh_auditor_show_entity_stream', {'entity': helper.namespaceToParam(entity), 'id': entry.objectId}) }}"
                       class="font-medium text-slate-900 dark:text-slate-100 hover:underline shrink-0"
                       title="{{ entity }}"
                       onclick="event.stopPropagation();">
                        {{ entity|split('\\')|last }} #{{ entry.objectId }}
                    </a>

                    {# Entity label if available - smaller and italic #}
                    {% if entity_label %}
                        <span class="text-slate-500 dark:text-slate-400">·</span>
                        <span class="text-xs italic text-slate-500 dark:text-slate-400 truncate">{{ entity_label }}</span>
                    {% endif %}

                    {# Action description #}
                    <span class="text-slate-500 dark:text-slate-400">·</span>
                    <span class="text-slate-400 dark:text-slate-500 italic shrink-0">
                        {% if entry.type == 'insert' %}
                            {% trans from 'auditor' %}audit.entry.action_insert{% endtrans %}
                        {% elseif entry.type == 'update' %}
                            {% trans from 'auditor' %}audit.entry.action_update{% endtrans %}
                        {% elseif entry.type == 'remove' %}
                            {% trans from 'auditor' %}audit.entry.action_remove{% endtrans %}
                        {% elseif entry.type == 'associate' %}
                            {% trans from 'auditor' %}audit.entry.action_associate{% endtrans %}
                        {% elseif entry.type == 'dissociate' %}
                            {% trans from 'auditor' %}audit.entry.action_dissociate{% endtrans %}
                        {% endif %}
                    </span>
                </div>
            </div>

            <div class="flex items-center gap-4 text-sm text-slate-500 dark:text-slate-400 shrink-0">
                {# Transaction hash - short version with full hash in title #}
                {% if entry.transactionHash is not empty and hide_transaction is not defined %}
                    <a href="{{ path('dh_auditor_show_transaction_stream', {hash: entry.transactionHash}) }}"
                       class="font-mono text-xs text-slate-400 hover:underline transition"
                       title="{{ entry.transactionHash }}"
                       onclick="event.stopPropagation();">
                        {{ entry.transactionHash|slice(0, 10) }}…
                    </a>
                {% endif %}

                {# Chevron #}
                <svg class="w-4 h-4 text-slate-400 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>

        {# Second line: date and user/command #}
        <div class="flex items-center gap-2 mt-1 ml-2 text-xs text-slate-500 dark:text-slate-400">
            <span>{{ entry.createdAt|format_datetime('full', 'short') }}</span>
            <span>·</span>
            <span>{% trans from 'auditor' %}audit.entry.by{% endtrans %}
                <span class="font-medium">{{ entry.username ?? 'audit.audit_details.anonymous'|trans(domain='auditor') }}</span>
            </span>
        </div>
    </summary>

    {# Details content - diffs #}
    {% if entry.type == 'insert' %}
        <div class="px-4 pb-4">
            <div class="pl-4 text-sm font-mono">
                {% set diffs = entry.diffs %}
                {% for field, changeset in diffs %}
                    {% if field != 'label' %}
                        {{ _self.displayInsertValue(field, changeset) }}
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    {% elseif entry.type == 'update' %}
        <div class="px-4 pb-4">
            <div class="pl-4 text-sm font-mono">
                {% set diffs = entry.diffs %}
                {% for field, changeset in diffs %}
                    {% if field != 'label' %}
                        {{ _self.displayUpdateDiff(field, changeset) }}
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    {% elseif entry.type == 'associate' %}
        <div class="px-4 pb-4">
            <div class="pl-4 text-sm font-mono">
                {% set diffs = entry.diffs %}
                {% if diffs.source is defined and diffs.target is defined %}
                    {% set target_id = diffs.target.pkName is defined ? diffs.target[diffs.target.pkName] : diffs.target.id %}

                    <div class="flex items-center py-0.5">
                        <span class="min-w-48 shrink-0 text-blue-600 dark:text-blue-400">{{ diffs.source.class|split('\\')|last }} #{{ diffs.source.id }}</span>
                        <span class="w-8 text-center text-slate-400">→</span>
                        <a href="{{ path('dh_auditor_show_entity_stream', { 'entity': helper.namespaceToParam(diffs.target.class), 'id': target_id }) }}"
                           class="text-blue-600 dark:text-blue-400 hover:underline">
                            {{ diffs.target.class|split('\\')|last }} #{{ target_id }}
                        </a>
                    </div>
                    {% if diffs.source.label is defined or diffs.target.label is defined %}
                        <div class="flex items-center py-0.5">
                            <span class="min-w-48 shrink-0 text-xs italic text-slate-500 dark:text-slate-400">{{ diffs.source.label|default('') }}</span>
                            <span class="w-8 text-center text-slate-300 dark:text-slate-600">→</span>
                            <span class="text-xs italic text-slate-500 dark:text-slate-400">{{ diffs.target.label|default('') }}</span>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    {% elseif entry.type == 'dissociate' %}
        <div class="px-4 pb-4">
            <div class="pl-4 text-sm font-mono">
                {% set diffs = entry.diffs %}
                {% if diffs.source is defined and diffs.target is defined %}
                    {% set target_id = diffs.target.pkName is defined ? diffs.target[diffs.target.pkName] : diffs.target.id %}

                    <div class="flex items-center py-0.5">
                        <span class="min-w-48 shrink-0 text-rose-600 dark:text-rose-400">{{ diffs.source.class|split('\\')|last }} #{{ diffs.source.id }}</span>
                        <span class="w-8 text-center text-slate-400">→</span>
                        <a href="{{ path('dh_auditor_show_entity_stream', { 'entity': helper.namespaceToParam(diffs.target.class), 'id': target_id }) }}"
                           class="text-rose-600 dark:text-rose-400 hover:underline">
                            {{ diffs.target.class|split('\\')|last }} #{{ target_id }}
                        </a>
                    </div>
                    {% if diffs.source.label is defined or diffs.target.label is defined %}
                        <div class="flex items-center py-0.5">
                            <span class="min-w-48 shrink-0 text-xs italic text-slate-500 dark:text-slate-400">{{ diffs.source.label|default('') }}</span>
                            <span class="w-8 text-center text-slate-300 dark:text-slate-600">→</span>
                            <span class="text-xs italic text-slate-500 dark:text-slate-400">{{ diffs.target.label|default('') }}</span>
                        </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    {% elseif entry.type == 'remove' %}
        {# No details for remove - the action description is enough #}
    {% endif %}
</details>

{# Macro for INSERT: display only the new value in emerald #}
{% macro displayInsertValue(field, changeset) %}
    {% import '@DHAuditor/Audit/helpers/helper.html.twig' as helper %}
    {% if changeset.new is defined %}
        <div class="flex items-start py-0.5">
            <span class="text-slate-500 dark:text-slate-400 min-w-48 shrink-0">{{ field }}</span>
            <span class="text-emerald-600 dark:text-emerald-400">{{ helper.dump(changeset.new) }}</span>
        </div>
    {% elseif changeset is iterable and changeset.old is not defined and changeset.new is not defined %}
        {# JSON nested field #}
        {% for json_field, json_changeset in changeset %}
            {{ _self.displayInsertValue(field ~ '.' ~ json_field, json_changeset) }}
        {% endfor %}
    {% endif %}
{% endmacro %}

{# Macro for UPDATE: display old (rose strikethrough) → new (indigo) #}
{% macro displayUpdateDiff(field, changeset) %}
    {% import '@DHAuditor/Audit/helpers/helper.html.twig' as helper %}
    {% if changeset.old is defined or changeset.new is defined %}
        <div class="flex items-start py-0.5">
            <span class="text-slate-500 dark:text-slate-400 min-w-48 shrink-0">{{ field }}</span>
            <span class="min-w-32 shrink-0">
                {% if changeset.old is defined and changeset.old is not null %}
                    <span class="text-rose-500 dark:text-rose-400 line-through">{{ helper.dump(changeset.old) }}</span>
                {% else %}
                    <span class="text-slate-300 dark:text-slate-600">⌀</span>
                {% endif %}
            </span>
            <span class="w-8 text-center text-slate-400 dark:text-slate-500 shrink-0">→</span>
            <span>
                {% if changeset.new is defined and changeset.new is not null %}
                    <span class="text-indigo-600 dark:text-indigo-400">{{ helper.dump(changeset.new) }}</span>
                {% else %}
                    <span class="text-slate-300 dark:text-slate-600">⌀</span>
                {% endif %}
            </span>
        </div>
    {% else %}
        {# JSON nested field #}
        {% for json_field, json_changeset in changeset %}
            {{ _self.displayUpdateDiff(field ~ '.' ~ json_field, json_changeset) }}
        {% endfor %}
    {% endif %}
{% endmacro %}
