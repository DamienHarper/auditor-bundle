{% import '@DHAuditor/Audit/helpers/helper.html.twig' as helper %}

{# Get entity label from diffs if available #}
{% set entity_label = null %}
{% if entry.diffs.label is defined %}
    {% set entity_label = entry.diffs.label %}
{% endif %}

{% if entry.type == 'remove' %}
{# REMOVE entries are not expandable #}
<div class="flex flex-col px-4 py-3 hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
    {# First line: badge, entity link, label, action description, hash #}
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-3 min-w-0">
            {# Type badge - fixed width for alignment #}
            <span class="w-24 shrink-0">
                {{ helper.type_badge(entry.type) }}
            </span>

            {# Entity info #}
            <div class="flex items-center gap-2 min-w-0 text-sm">
                {# Entity name + ID #}
                <a href="{{ path('dh_auditor_show_entity_stream', {'entity': helper.namespaceToParam(entity), 'id': entry.objectId}) }}"
                   class="font-medium text-slate-900 dark:text-slate-100 hover:underline shrink-0"
                   title="{{ entity }}">
                    {{ entity|split('\\')|last }} #{{ entry.objectId }}
                </a>

                {# Entity label if available - smaller and italic #}
                {% if entity_label %}
                    <span class="text-slate-500 dark:text-slate-400">·</span>
                    <span class="text-xs italic text-slate-500 dark:text-slate-400 truncate">{{ entity_label }}</span>
                {% endif %}

                {# Action description #}
                <span class="text-slate-500 dark:text-slate-400">·</span>
                <span class="text-xs text-slate-400 dark:text-slate-500 italic shrink-0">
                    {% trans from 'auditor' %}audit.entry.action_remove{% endtrans %}
                </span>
            </div>
        </div>

        <div class="flex items-center gap-4 text-sm text-slate-500 dark:text-slate-400 shrink-0">
            {# Transaction hash - short version with full hash in title #}
            {% if entry.transactionHash is not empty and hide_transaction is not defined %}
                <a href="{{ path('dh_auditor_show_transaction_stream', {hash: entry.transactionHash}) }}"
                   class="font-mono text-xs text-slate-400 hover:underline transition"
                   title="{{ entry.transactionHash }}">
                    {{ entry.transactionHash|slice(0, 10) }}…
                </a>
            {% endif %}
            {# Spacer to align with chevron in other rows #}
            <span class="w-4"></span>
        </div>
    </div>

    {# Second line: date and user/command #}
    <div class="flex items-center gap-2 mt-1 ml-2 text-xs text-slate-500 dark:text-slate-400">
        <span>{{ entry.createdAt|format_datetime('full', 'short') }}</span>
        <span>·</span>
        <span>{% trans from 'auditor' %}audit.entry.by{% endtrans %}
            <span class="font-medium">{{ entry.username ?? 'audit.audit_details.anonymous'|trans(domain='auditor') }}</span>
        </span>
    </div>
</div>
{% else %}
{# Other entry types are expandable #}
<details class="group hover:bg-slate-50 dark:hover:bg-slate-800/50 transition">
    <summary class="flex flex-col px-4 py-3 cursor-pointer list-none">
        {# First line: badge, entity link, label, action description, hash, chevron #}
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3 min-w-0">
                {# Type badge - fixed width for alignment #}
                <span class="w-24 shrink-0">
                    {{ helper.type_badge(entry.type) }}
                </span>

                {# Entity info #}
                <div class="flex items-center gap-2 min-w-0 text-sm">
                    {# Entity name + ID #}
                    <a href="{{ path('dh_auditor_show_entity_stream', {'entity': helper.namespaceToParam(entity), 'id': entry.objectId}) }}"
                       class="font-medium text-slate-900 dark:text-slate-100 hover:underline shrink-0"
                       title="{{ entity }}"
                       onclick="event.stopPropagation();">
                        {{ entity|split('\\')|last }} #{{ entry.objectId }}
                    </a>

                    {# Entity label if available - smaller and italic #}
                    {% if entity_label %}
                        <span class="text-slate-500 dark:text-slate-400">·</span>
                        <span class="text-xs italic text-slate-500 dark:text-slate-400 truncate">{{ entity_label }}</span>
                    {% endif %}

                    {# Action description #}
                    <span class="text-slate-500 dark:text-slate-400">·</span>
                    <span class="text-slate-400 dark:text-slate-500 text-xs italic shrink-0">
                        {% if entry.type == 'insert' %}
                            {% trans from 'auditor' %}audit.entry.action_insert{% endtrans %}
                        {% elseif entry.type == 'update' %}
                            {% trans from 'auditor' %}audit.entry.action_update{% endtrans %}
                        {% elseif entry.type == 'associate' %}
                            {% trans from 'auditor' %}audit.entry.action_associate{% endtrans %}
                        {% elseif entry.type == 'dissociate' %}
                            {% trans from 'auditor' %}audit.entry.action_dissociate{% endtrans %}
                        {% endif %}
                    </span>
                </div>
            </div>

            <div class="flex items-center gap-4 text-sm text-slate-500 dark:text-slate-400 shrink-0">
                {# Transaction hash - short version with full hash in title #}
                {% if entry.transactionHash is not empty and hide_transaction is not defined %}
                    <a href="{{ path('dh_auditor_show_transaction_stream', {hash: entry.transactionHash}) }}"
                       class="font-mono text-xs text-slate-400 hover:underline transition"
                       title="{{ entry.transactionHash }}"
                       onclick="event.stopPropagation();">
                        {{ entry.transactionHash|slice(0, 10) }}…
                    </a>
                {% endif %}

                {# Chevron #}
                <svg class="w-4 h-4 text-slate-400 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </div>

        {# Second line: date and user/command #}
        <div class="flex items-center gap-2 mt-1 ml-2 text-xs text-slate-500 dark:text-slate-400">
            <span>{{ entry.createdAt|format_datetime('full', 'short') }}</span>
            <span>·</span>
            <span>{% trans from 'auditor' %}audit.entry.by{% endtrans %}
                <span class="font-medium">{{ entry.username ?? 'audit.audit_details.anonymous'|trans(domain='auditor') }}</span>
            </span>
        </div>
    </summary>

    {# Details content - diffs #}
    {% if entry.type == 'insert' %}
        <div class="px-4 pb-4 pl-8">
            <table class="text-xs font-mono">
                {% set diffs = entry.diffs %}
                {% for field, changeset in diffs %}
                    {% if field != 'label' %}
                        {{ _self.displayInsertValue(field, changeset) }}
                    {% endif %}
                {% endfor %}
            </table>
        </div>
    {% elseif entry.type == 'update' %}
        <div class="px-4 pb-4 pl-8">
            <table class="text-xs font-mono">
                {% set diffs = entry.diffs %}
                {% for field, changeset in diffs %}
                    {% if field != 'label' %}
                        {{ _self.displayUpdateDiff(field, changeset) }}
                    {% endif %}
                {% endfor %}
            </table>
        </div>
    {% elseif entry.type == 'associate' %}
        <div class="px-4 pb-4 pl-8">
            <table class="text-xs font-mono">
                {% set diffs = entry.diffs %}
                {% if diffs.source is defined and diffs.target is defined %}
                    {% set target_id = diffs.target.pkName is defined ? diffs.target[diffs.target.pkName] : diffs.target.id %}
                    <tr>
                        <td class="pr-3 text-blue-600 dark:text-blue-400 break-words" style="max-width: 45%;">
                            <a href="{{ path('dh_auditor_show_entity_stream', { 'entity': helper.namespaceToParam(diffs.source.class), 'id': diffs.source.id }) }}"
                               class="hover:underline" title="{{ diffs.source.class }}">
                                {{ diffs.source.class|split('\\')|last }} #{{ diffs.source.id }}
                            </a>
                        </td>
                        <td class="px-2 text-slate-400">
                            <svg class="w-5 h-5" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path opacity=".4" d=""/><path d="M497 441L601 337C610.4 327.6 610.4 312.4 601 303.1L497 199C487.6 189.6 472.4 189.6 463.1 199C453.8 208.4 453.7 223.6 463.1 232.9L526.1 295.9L114 295.9L177 232.9C186.4 223.5 186.4 208.3 177 199C167.6 189.7 152.4 189.6 143.1 199L39 303C29.6 312.4 29.6 327.6 39 336.9L143 441C152.4 450.4 167.6 450.4 176.9 441C186.2 431.6 186.3 416.4 176.9 407.1L113.9 344.1L526 344.1L463 407.1C453.6 416.5 453.6 431.7 463 441C472.4 450.3 487.6 450.4 496.9 441z"/></svg>
                        </td>
                        <td class="pl-3 text-blue-600 dark:text-blue-400 break-words" style="max-width: 45%;">
                            <a href="{{ path('dh_auditor_show_entity_stream', { 'entity': helper.namespaceToParam(diffs.target.class), 'id': target_id }) }}"
                               class="hover:underline" title="{{ diffs.target.class }}">
                                {{ diffs.target.class|split('\\')|last }} #{{ target_id }}
                            </a>
                        </td>
                    </tr>
                    {% if diffs.source.label is defined or diffs.target.label is defined %}
                        <tr class="text-xs italic text-slate-500 dark:text-slate-400">
                            <td class="pr-3 break-words" style="max-width: 45%;">{{ diffs.source.label|default('—') }}</td>
                            <td></td>
                            <td class="pl-3 break-words" style="max-width: 45%;">{{ diffs.target.label|default('—') }}</td>
                        </tr>
                    {% endif %}
                {% endif %}
            </table>
        </div>
    {% elseif entry.type == 'dissociate' %}
        <div class="px-4 pb-4 pl-8">
            <table class="text-xs font-mono">
                {% set diffs = entry.diffs %}
                {% if diffs.source is defined and diffs.target is defined %}
                    {% set target_id = diffs.target.pkName is defined ? diffs.target[diffs.target.pkName] : diffs.target.id %}
                    <tr>
                        <td class="pr-3 text-rose-600 dark:text-rose-400 break-words" style="max-width: 45%;">
                            <a href="{{ path('dh_auditor_show_entity_stream', { 'entity': helper.namespaceToParam(diffs.source.class), 'id': diffs.source.id }) }}"
                               class="hover:underline" title="{{ diffs.source.class }}">
                                {{ diffs.source.class|split('\\')|last }} #{{ diffs.source.id }}
                            </a>
                        </td>
                        <td class="px-2 text-slate-400">
                            <svg class="w-5 h-5" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path opacity=".4" d=""/><path d="M497 441L601 337C610.4 327.6 610.4 312.4 601 303.1L497 199C487.6 189.6 472.4 189.6 463.1 199C453.8 208.4 453.7 223.6 463.1 232.9L526.1 295.9L114 295.9L177 232.9C186.4 223.5 186.4 208.3 177 199C167.6 189.7 152.4 189.6 143.1 199L39 303C29.6 312.4 29.6 327.6 39 336.9L143 441C152.4 450.4 167.6 450.4 176.9 441C186.2 431.6 186.3 416.4 176.9 407.1L113.9 344.1L526 344.1L463 407.1C453.6 416.5 453.6 431.7 463 441C472.4 450.3 487.6 450.4 496.9 441z"/></svg>
                        </td>
                        <td class="pl-3 text-rose-600 dark:text-rose-400 break-words" style="max-width: 45%;">
                            <a href="{{ path('dh_auditor_show_entity_stream', { 'entity': helper.namespaceToParam(diffs.target.class), 'id': target_id }) }}"
                               class="hover:underline" title="{{ diffs.target.class }}">
                                {{ diffs.target.class|split('\\')|last }} #{{ target_id }}
                            </a>
                        </td>
                    </tr>
                    {% if diffs.source.label is defined or diffs.target.label is defined %}
                        <tr class="text-xs italic text-slate-500 dark:text-slate-400">
                            <td class="pr-3 break-words" style="max-width: 45%;">{{ diffs.source.label|default('—') }}</td>
                            <td></td>
                            <td class="pl-3 break-words" style="max-width: 45%;">{{ diffs.target.label|default('—') }}</td>
                        </tr>
                    {% endif %}
                {% endif %}
            </table>
        </div>
    {% endif %}
</details>
{% endif %}

{# Macro for INSERT: table row with field and value #}
{% macro displayInsertValue(field, changeset) %}
    {% import '@DHAuditor/Audit/helpers/helper.html.twig' as helper %}
    {% if changeset.new is defined %}
        <tr>
            <td class="pr-6 text-slate-500 dark:text-slate-400 break-words" style="max-width: 25%;">{{ field }}</td>
            <td class="text-emerald-600 dark:text-emerald-400 break-words" style="max-width: 70%;">{{ helper.dump(changeset.new) }}</td>
        </tr>
    {% elseif changeset is iterable and changeset.old is not defined and changeset.new is not defined %}
        {# JSON nested field #}
        {% for json_field, json_changeset in changeset %}
            {{ _self.displayInsertValue(field ~ '.' ~ json_field, json_changeset) }}
        {% endfor %}
    {% endif %}
{% endmacro %}

{# Macro for UPDATE: table row with field, old value, arrow, new value #}
{% macro displayUpdateDiff(field, changeset) %}
    {% import '@DHAuditor/Audit/helpers/helper.html.twig' as helper %}
    {% if changeset.old is defined or changeset.new is defined %}
        <tr>
            <td class="pr-6 text-slate-500 dark:text-slate-400 break-words" style="max-width: 20%;">{{ field }}</td>
            <td class="pr-3 text-slate-400 dark:text-slate-500 break-words" style="max-width: 25%;">
                {% if changeset.old is defined and changeset.old is not null %}
                    {{ helper.dump(changeset.old) }}
                {% else %}
                    ⌀
                {% endif %}
            </td>
            <td class="px-2 text-slate-400 dark:text-slate-500 whitespace-nowrap">→</td>
            <td class="pl-3 text-indigo-600 dark:text-indigo-400 break-words" style="max-width: 40%;">
                {% if changeset.new is defined and changeset.new is not null %}
                    {{ helper.dump(changeset.new) }}
                {% else %}
                    ⌀
                {% endif %}
            </td>
        </tr>
    {% else %}
        {# JSON nested field #}
        {% for json_field, json_changeset in changeset %}
            {{ _self.displayUpdateDiff(field ~ '.' ~ json_field, json_changeset) }}
        {% endfor %}
    {% endif %}
{% endmacro %}
