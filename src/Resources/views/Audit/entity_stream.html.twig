{% extends "@DHAuditor/layout.html.twig" %}

{% import '@DHAuditor/Audit/helpers/helper.html.twig' as helper %}
{% import '@DHAuditor/Audit/helpers/pager.html.twig' as pager %}

{% block dh_auditor_content %}
    {# Sub-header - sticky with back link #}
    <div class="sticky top-16 z-40 -mx-6 px-6 py-3 mb-4 bg-slate-50/80 dark:bg-slate-950/80 backdrop-blur">
        {# Back link #}
        <a href="{{ path('dh_auditor_list_audits') }}"
           class="inline-flex items-center text-sm text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 mb-3">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            {{ 'audit.header.back_to_entities'|trans(domain='auditor') }}
        </a>

        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h1 class="text-lg font-semibold text-slate-900 dark:text-slate-100" title="{{ entity }}">
                    {{ entity|split('\\')|last }}{% if id is not null %} #{{ id }}{% endif %}
                </h1>
                <p class="text-sm text-slate-500 dark:text-slate-400">
                    {{ 'audit.audit_details.events_count'|trans({'%count%': paginator.numResults|number_format}, 'auditor') }}
                    Â· {{ 'audit.audit_details.most_recent'|trans(domain='auditor') }}
                </p>
            </div>
            <div class="flex gap-2 mt-3 sm:mt-0">
                {# Type filter #}
                <select id="filter-type"
                        class="text-sm border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-1.5 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300"
                        onchange="applyFilters()">
                    <option value="">{{ 'audit.filter.all_actions'|trans(domain='auditor') }}</option>
                    {% for type in filterOptions.types %}
                        <option value="{{ type }}" {% if filters.type == type %}selected{% endif %}>
                            {{ ('audit.filter.type.' ~ type)|trans(domain='auditor') }}
                        </option>
                    {% endfor %}
                </select>

                {# User filter #}
                <select id="filter-user"
                        class="text-sm border border-slate-200 dark:border-slate-700 rounded-lg px-3 py-1.5 bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-300"
                        onchange="applyFilters()">
                    <option value="">{{ 'audit.filter.all_users'|trans(domain='auditor') }}</option>
                    {% for user in filterOptions.users %}
                        <option value="{{ user.id }}" {% if filters.user == user.id %}selected{% endif %}>
                            {{ user.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    {# Entries list #}
    <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 divide-y divide-slate-200 dark:divide-slate-800">
        {% for entry in paginator.results %}
            {{ include('@DHAuditor/Audit/entry.html.twig', {'entry': entry, 'entity': entity}) }}
        {% else %}
            <div class="p-8 text-center text-slate-500 dark:text-slate-400">
                {{ 'audit.stream.no_entries'|trans(domain='auditor') }}
            </div>
        {% endfor %}
    </div>

    {# Pager #}
    {% block dh_auditor_pager %}
        {{ pager.render(helper.namespaceToParam(entity), id, paginator, filters) }}
    {% endblock dh_auditor_pager %}

    <script>
        function applyFilters() {
            const type = document.getElementById('filter-type').value;
            const user = document.getElementById('filter-user').value;
            const url = new URL(window.location.href);

            // Reset to page 1 when filters change
            url.searchParams.delete('page');

            if (type) {
                url.searchParams.set('type', type);
            } else {
                url.searchParams.delete('type');
            }

            if (user) {
                url.searchParams.set('user', user);
            } else {
                url.searchParams.delete('user');
            }

            window.location.href = url.toString();
        }
    </script>
{% endblock dh_auditor_content %}
