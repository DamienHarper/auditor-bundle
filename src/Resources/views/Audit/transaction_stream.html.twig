{% extends "@DHAuditor/layout.html.twig" %}

{% import '@DHAuditor/Audit/helpers/helper.html.twig' as helper %}

{% block dh_auditor_content %}
    {# Sub-header - sticky with back link #}
    <div class="sticky top-16 z-40 -mx-6 px-6 py-3 mb-4 bg-slate-50/80 dark:bg-slate-950/80 backdrop-blur">
        {# Back link #}
        <a href="{{ path('dh_auditor_list_audits') }}"
           class="inline-flex items-center text-sm text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 mb-3">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
            {% trans from 'auditor' %}audit.header.back_to_entities{% endtrans %}
        </a>

        <div>
            <h1 class="text-lg font-semibold text-slate-900 dark:text-slate-100 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                </svg>
                {% trans from 'auditor' %}audit.transaction.title{% endtrans %}
            </h1>
            {% set total = 0 %}
            {% for entity, entries in audits %}
                {% set total = total + entries|length %}
            {% endfor %}
            <p class="text-sm text-slate-500 dark:text-slate-400">
                <span class="font-mono">{{ hash }}</span>
                · {% trans with { '%count%': total } from 'auditor' %}audit.audit_details.events_count{% endtrans %}
            </p>
        </div>
    </div>

    {# Entries grouped by entity #}
    {% for entity, entries in audits %}
        <div class="mb-6">
            <h2 class="sticky z-30 -mx-6 px-6 py-2 text-base font-medium text-slate-700 dark:text-slate-300 bg-slate-50/80 dark:bg-slate-950/80 backdrop-blur" style="top: 10.5rem;">
                <a href="{{ path('dh_auditor_show_entity_stream', {'entity': helper.namespaceToParam(entity)}) }}"
                   class="hover:underline"
                   title="{{ entity }}">
                    {{ entity|split('\\')|last }}
                </a>
                <span class="text-slate-400 dark:text-slate-500 font-normal">
                    · {% trans with { '%count%': entries|length } from 'auditor' %}audit.audit_details.events_count{% endtrans %}
                </span>
            </h2>
            <div class="rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 divide-y divide-slate-200 dark:divide-slate-800">
                {% for entry in entries %}
                    {{ include('@DHAuditor/Audit/entry.html.twig', {'entry': entry, 'entity': entity, 'hide_transaction': true}) }}
                {% endfor %}
            </div>
        </div>
    {% else %}
        <div class="p-8 text-center text-slate-500 dark:text-slate-400 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900">
            {% trans from 'auditor' %}audit.stream.no_entries{% endtrans %}
        </div>
    {% endfor %}
{% endblock dh_auditor_content %}
