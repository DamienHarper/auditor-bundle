This guide covers upgrading from auditor-bundle 6.x to 7.0.

## Requirements Changes

### PHP

 6.x       7.0      
---------------------
 >= 8.2    >= 8.4   

### Symfony

 6.x       7.0      
---------------------
 >= 5.4    >= 8.0   

Symfony 5.4, 6.x, and 7.x are **no longer supported**.

### Doctrine

 Package          6.x       7.0      
-------------------------------------
 DBAL             >= 3.2    >= 4.0   
 ORM              >= 2.13   >= 3.2   
 DoctrineBundle   >= 2.0    >= 3.0   

### auditor Library

 6.x       7.0      
---------------------
 >= 3.0    >= 4.0   

See [auditor upgrade guide](https://github.com/DamienHarper/auditor/blob/master/docs/upgrade/v4.md).

## Bundle Changes

### AbstractBundle Migration

The bundle now extends `Symfony\Component\HttpKernel\Bundle\AbstractBundle` instead of `Bundle`.

This is an internal change and doesn't affect your configuration.

### Removed Classes

 Removed Class                                                               Reason                                       
-------------------------------------------------------------------------------------------------------------------------
 `DH\AuditorBundle\DependencyInjection\Configuration`                        Merged into `DHAuditorBundle::configure()`   
 `DH\AuditorBundle\DependencyInjection\DHAuditorExtension`                   Merged into `DHAuditorBundle::loadExtension()`
 `DH\AuditorBundle\DependencyInjection\Compiler\AddProviderCompilerPass`     No longer needed with autowiring             
 `DH\AuditorBundle\DependencyInjection\Compiler\CustomConfigurationCompilerPass`  Merged into bundle                      
 `DH\AuditorBundle\DependencyInjection\Compiler\DoctrineProviderConfigurationCompilerPass`  Replaced by `DoctrineMiddlewareCompilerPass`

### Removed Files

- `src/Resources/config/services.yaml` - Services defined programmatically

## Upgrade Steps

### 1. Update PHP

Ensure you have PHP 8.4+:

```bash
php -v
# PHP 8.4.x ...
```

### 2. Update Symfony

```bash
composer require symfony/framework-bundle:^8.0
```

### 3. Update Doctrine

```bash
composer require \
    doctrine/dbal:^4.0 \
    doctrine/orm:^3.2 \
    doctrine/doctrine-bundle:^3.0
```

### 4. Update auditor

```bash
composer require damienharper/auditor:^4.0
```

### 5. Update auditor-bundle

```bash
composer require damienharper/auditor-bundle:^7.0
```

### 6. Clear Cache

```bash
bin/console cache:clear
```

### 7. Check Schema

```bash
bin/console audit:schema:update --dump-sql
```

### 8. Run Tests

```bash
bin/phpunit
```

## Configuration

No configuration changes required. Your `dh_auditor.yaml` should work as-is.

## Breaking Changes

### UserProvider

The `AnonymousToken` handling was removed (deprecated in Symfony 6.0).

**Before (6.x):**
```php
if ($token instanceof AnonymousToken) {
    return null;
}
```

**After (7.0):**
Anonymous tokens no longer exist in Symfony 8.0.

### Custom Providers

If you have custom providers extending bundle classes, verify they still work.

The provider interfaces from the `auditor` library haven't changed:

- `UserProviderInterface`
- `SecurityProviderInterface`
- `RoleCheckerInterface`

## Troubleshooting

### Class Not Found

If you get class not found errors for removed classes, you may have code referencing internal bundle classes. Update to use public APIs only.

### Configuration Errors

Clear cache and warmup:

```bash
bin/console cache:clear
bin/console cache:warmup
```

### Schema Issues

Check and update audit tables:

```bash
bin/console audit:schema:update --dump-sql
bin/console audit:schema:update --force
```

## Need Help?

- Check [GitHub Issues](https://github.com/DamienHarper/auditor-bundle/issues)
- Open a new issue with details about your error
